<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø¯Ø§Ø± Ø§Ù„Ø³Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ</title>
    <!-- Google Fonts: IBM Plex Sans Arabic -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-main: #f8f9fa;
            --text-color: #343a40;
            --author-color: #6c757d;
            --border-color: #dee2e6;
            --accent-color-1: #ffc107; /* Yellow */
            --accent-color-2: #fd7e14; /* Orange */
            --shadow-color: rgba(0,0,0,0.1);
        }

        body {
            font-family: 'IBM Plex Sans Arabic', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-color);
            margin: 0;
            overflow-y: auto;
        }
        
        .page-wrapper {
            padding: 40px 20px;
        }
        
        /* Main message from you */
        .main-letter {
            max-width: 800px;
            margin: 0 auto 60px auto;
            background: #ffffff;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.08);
            text-align: center;
            border: 1px solid var(--border-color);
            position: relative;
        }
        .main-letter h1 {
            font-size: 2.8em;
            font-weight: 700;
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: 25px;
        }
        .main-letter p {
            font-size: 1.25em;
            line-height: 1.9;
            color: #495057;
            font-weight: 400;
            margin-bottom: 20px;
        }
        .main-letter hr {
            border: 0;
            height: 1px;
            background-color: var(--border-color);
            margin: 30px auto;
            width: 80%;
        }
        .main-letter .call-to-action {
            font-size: 1.3em;
            font-weight: 600;
            color: var(--accent-color-2);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
         .main-letter .signature {
            font-size: 1.2em;
            font-weight: 400;
            margin-top: 40px;
            margin-bottom: 0;
            color: var(--author-color);
        }
        .main-letter .signature strong {
            display: block;
            font-size: 1.5em;
            font-weight: 700;
            color: var(--text-color);
        }

        /* Wall container using CSS Grid for Masonry effect */
        .wall-container {
            max-width: 1300px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            grid-auto-rows: 10px;
            gap: 25px;
            padding: 0 10px;
        }
        
        .card {
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 5px 15px var(--shadow-color);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
            animation: fadeIn 0.5s ease-out;
            display: flex;
            flex-direction: column;
        }
        
        /* Different card colors */
        .card:nth-child(4n+1) { background-color: #fffde7; } /* Light Yellow */
        .card:nth-child(4n+2) { background-color: #e0f7fa; } /* Light Cyan */
        .card:nth-child(4n+3) { background-color: #fce4ec; } /* Light Pink */
        .card:nth-child(4n+4) { background-color: #e8f5e9; } /* Light Green */

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card:hover {
            transform: translateY(-5px) rotate(1deg);
            box-shadow: 0 12px 25px var(--shadow-color);
        }
        
        /* Public card message */
        .card-message {
            font-size: 1.1em;
            font-weight: 400;
            margin: 0 0 20px 0;
            flex-grow: 1;
            line-height: 1.7;
            color: #212529;
            white-space: pre-wrap; /* To respect new lines */
        }

        /* Private card content */
        .card-private-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            cursor: pointer;
        }
        .lock-icon {
            color: var(--accent-color-2);
            opacity: 0.8;
        }
        .card.is-read .lock-icon {
            color: #adb5bd; /* Gray out when read */
        }

        .private-text {
            font-weight: 600;
            margin-top: 10px;
        }

        .card-author {
            font-size: 0.95em;
            color: var(--author-color);
            border-top: 1px solid var(--border-color);
            padding-top: 15px;
            margin-top: 20px;
            text-align: left;
            font-weight: 400;
        }

        .delete-card-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 30px;
            height: 30px;
            background: rgba(0,0,0,0.05);
            border: none;
            border-radius: 50%;
            color: #6c757d;
            cursor: pointer;
            opacity: 0.4;
            transition: all 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .card:hover .delete-card-btn { opacity: 1; }
        .delete-card-btn:hover { background: #ef4444; color: white; }
        
        /* Shared styles for Panel, Modal, etc. */
        .form-panel, .modal-overlay, #notification-area, #open-form-btn { font-family: 'IBM Plex Sans Arabic', sans-serif; }
        .form-panel { position: fixed; top: 0; right: 0; width: 100%; max-width: 420px; height: 100vh; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(15px); border-left: 1px solid var(--border-color); z-index: 10; transform: translateX(100%); transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); display: flex; flex-direction: column; padding: 25px; box-sizing: border-box; color: var(--text-color); }
        .form-panel.show { transform: translateX(0); }
        .form-panel h1 { font-size: 2em; text-align: center; }
        #open-form-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background: var(--accent-color-2); color: white; border: none; border-radius: 50%; font-size: 36px; line-height: 60px; text-align: center; cursor: pointer; z-index: 5; box-shadow: 0 5px 20px rgba(253, 126, 20, 0.4); }
        #close-form-btn { position: absolute; top: 15px; left: 15px; background: transparent; border: none; color: #6c757d; font-size: 28px; cursor: pointer; }
        #gratitude-form { flex-grow: 1; display: flex; flex-direction: column; }
        #gratitude-form textarea, #gratitude-form input { background: #f8f9fa; color: var(--text-color); border: 1px solid var(--border-color); }
        #gratitude-form input, #gratitude-form textarea { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        #gratitude-form button[type="submit"] { width: 100%; padding: 12px; background: var(--accent-color-2); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; font-weight: bold; margin-top: auto; }
        .privacy-options { margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; }
        .privacy-options legend { padding: 0 10px; font-weight: 600; }
        .privacy-options div { display: flex; align-items: center; margin: 10px 0; }
        .privacy-options input[type="radio"] { margin-left: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1001; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
        .modal-overlay.show { opacity: 1; visibility: visible; }
        .modal-content { color: var(--text-color); background: white; padding: 30px; border-radius: 10px; text-align: right; width: 90%; max-width: 500px; border: 1px solid var(--border-color); transform: scale(0.9); transition: transform 0.3s ease; }
        .modal-overlay.show .modal-content { transform: scale(1); }
        .modal-content h3 { margin-top: 0; text-align: center; }
        #password-input { width: 100%; padding: 10px; text-align: center; background: #f1f3f5; border: 1px solid var(--border-color); color: var(--text-color); border-radius: 6px; margin-bottom: 15px; box-sizing: border-box; }
        .modal-buttons { margin-top: 20px; text-align: center;}
        .modal-buttons button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; margin: 0 5px; font-weight: 600; }
        #confirm-action-btn { background-color: var(--accent-color-2); color: white; }
        #cancel-action-btn { background-color: #ced4da; color: #495057; }
        #notification-area { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; }
        .notification { background-color: #343a40; color: white; padding: 12px 25px; border-radius: 8px; margin-top: 10px; opacity: 0; transition: all 0.5s; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .revealed-message-body {
            max-height: 50vh;
            overflow-y: auto;
            text-align: right;
            line-height: 1.8;
            margin-top: 20px;
            white-space: pre-wrap;
        }

    </style>
</head>
<body>

    <div class="page-wrapper">
        <!-- Your Main Message -->
        <div class="main-letter">
            <h1>Ø¥Ø²ÙŠÙƒÙ… ÙŠØ§ Ø¬Ù…Ø§Ø¹Ø©...</h1>
            <p>
                Ø¨ÙƒØªØ¨ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¯ÙŠ ÙˆØ£Ù†Ø§ Ù„Ø³Ù‡ Ø·Ø§Ù„Ø¹ Ù…Ù† Ø¢Ø®Ø± Ø§Ù…ØªØ­Ø§Ù†ØŒ ÙˆÙ„Ø³Ù‡ ÙÙŠØ§ Ù†ÙØ³ Ù…Ù† Ø§Ù„Ø³Ù†Ø© Ø¯ÙŠ Ø§Ù„Ù„ÙŠ Ø¹Ø¯Ù‘ØªØŒ Ø¨Ø³ ÙˆØ§Ù„Ù„Ù‡ Ø­Ø§Ø³Ø³ Ø¥Ù†Ù‡Ø§ ÙƒØ§Ù†Øª Ø£ÙƒØªØ± Ù…Ù† Ù…Ø¬Ø±Ø¯ Ø³Ù†Ø© Ø¯Ø±Ø§Ø³Ø©.
                Ø£ÙˆÙ„ Ø³Ù†Ø© ÙÙŠ Ø§Ù„ÙƒÙ„ÙŠØ© Ø¯ÙŠ ÙƒØ§Ù†Øª Ø¨Ø§Ù„Ù†Ø³Ø¨Ø© Ù„ÙŠ Ø±Ø­Ù„Ø©ØŒ ÙÙŠÙ‡Ø§ ÙƒÙ„ Ø­Ø§Ø¬Ø©: ØªÙˆØªØ± ÙˆØ¶ØºØ·ØŒ Ø¶Ø­Ùƒ Ù…Ù† Ø§Ù„Ù‚Ù„Ø¨ØŒ Ø³Ù‡Ø± Ø¹Ù„Ù‰ Ù…Ø´Ø§Ø±ÙŠØ¹ØŒ Ù‚Ù„Ù‚ Ù…Ù† Ø§Ù…ØªØ­Ø§Ù†Ø§ØªØŒ ÙˆÙ†Ø§Ø³ ÙƒØ¨Ø±Øª Ø¬ÙˆØ§ Ù‚Ù„Ø¨ÙŠ Ø­ØªÙ‰ Ù„Ùˆ Ù…Ø§ Ø§ØªÙƒÙ„Ù…Ù†Ø§Ø´ ÙƒØªÙŠØ±.
            </p>
            <p>
                Ø£Ù†Ø§ Ù…ÙƒÙ†ØªØ´ Ø£Ø¹Ø±Ù Ø§Ù„ÙƒÙ„ØŒ ÙˆØ¯Ù‡ Ø·Ø¨ÙŠØ¹ÙŠØŒ Ø¨Ø³ Ø§Ù„Ø¬Ù…ÙŠÙ„ Ø¨Ø¬Ø¯ Ø¥Ù† Ù†Ø§Ø³ ÙƒØªÙŠØ± Ø¹Ø±ÙØªÙ†ÙŠØŒ ÙˆÙ†Ø§Ø³ Ø£ÙƒØªØ± Ø´Ø¬Ø¹ØªÙ†ÙŠØŒ ÙˆÙ‚Ø§Ù„ÙˆÙ„ÙŠ ÙƒÙ„Ø§Ù… ÙØ±Ù‚ Ù…Ø¹Ø§ÙŠØ§ Ø£ÙƒØªØ± Ù…Ù…Ø§ ØªØªØ®ÙŠÙ„ÙˆØ§â€¦
                ÙƒÙ„Ù…Ø© "Ø´Ø¯ Ø­ÙŠÙ„Ùƒ"ØŒ Ø¶Ø­ÙƒØ© Ø¹Ù„Ù‰ Ø³Ù‡ÙˆØ©ØŒ Ù†Ø¸Ø±Ø© Ø¯Ø¹Ù…ØŒ Ø£Ùˆ Ø­ØªÙ‰ Ø³Ù„Ø§Ù… Ø¨Ø³ÙŠØ· ÙÙŠ Ø§Ù„Ù…Ù…Ø±â€¦ ÙƒÙ„ Ø¯Ù‡ ÙƒØ§Ù† Ø¨ÙŠØ®Ù„ÙŠÙ†ÙŠ Ø£ÙƒÙ…Ù„ ÙˆØ£Ù†Ø§ Ù…Ø¨Ø³ÙˆØ·.
            </p>
            <p>
                Ø§Ù„Ø³Ù†Ø© Ø¯ÙŠ Ø®Ù„ØªÙ†ÙŠ Ø£ÙƒØªØ´Ù Ù‚Ø¯ Ø¥ÙŠÙ‡ Ø§Ù„Ù†Ø§Ø³ Ø§Ù„Ø­Ù„ÙˆØ© Ø­ÙˆØ§Ù„ÙŠÙ†Ø§ Ø¨ØªØµÙ†Ø¹ Ø§Ù„ÙØ±Ù‚.
                Ù…Ø´ Ù„Ø§Ø²Ù… Ù†ÙƒÙˆÙ† ØµØ­Ø§Ø¨ ÙŠÙˆÙ…ÙŠÙ‹Ù‘Ø§ØŒ Ø¨Ø³ ÙƒÙØ§ÙŠØ© Ø§Ù„Ø¥Ø­Ø³Ø§Ø³ Ø¥Ù†Ù†Ø§ "Ù…Ø¹ Ø¨Ø¹Ø¶". ÙÙŠ Ù…ÙˆØ§Ù‚Ù ÙƒØªÙŠØ± Ù…Ø´ Ù‡ØªØªÙ†Ø³ÙŠâ€¦
                Ø¶Ø­ÙƒÙ†Ø§ ÙÙŠÙ‡Ø§ Ø¨Ø¬Ø¯ØŒ ÙˆØ¹ÙŠØ·Ù†Ø§ Ù…Ù† Ø§Ù„ØªØ¹Ø¨ØŒ ÙˆÙ‚ÙˆÙ„Ù†Ø§ "Ù‡Ùˆ Ø§Ø­Ù†Ø§ Ø¨Ù†Ø¹Ù…Ù„ ÙƒØ¯Ù‡ Ù„ÙŠÙ‡ØŸ" ÙˆØ¨Ø¹Ø¯ÙŠÙ† ÙƒÙ…Ù„Ù†Ø§ØŒ ÙˆÙƒØ£Ù† ÙƒÙ„ Ø­Ø§Ø¬Ø© Ù…Ø§Ø´ÙŠØ© Ø¨Ù†Ø¹Ù…Ø© Ø±Ø¨Ù†Ø§ØŒ ÙˆÙˆØ¬ÙˆØ¯Ù†Ø§ Ø­ÙˆØ§Ù„ÙŠÙ† Ø¨Ø¹Ø¶.
            </p>
             <p>
                Ø§Ù„Ù„ÙŠ ÙØ§Øª Ù…Ø´ Ù†Ù‡Ø§ÙŠØ©â€¦ Ø¯ÙŠ ÙƒØ§Ù†Øª Ø£ÙˆÙ„ Ø³Ù†Ø© Ù…Ù† Ù…Ø´ÙˆØ§Ø± Ø¹Ù…Ø±Ù‡ 4 Ø³Ù†ÙŠÙ†ØŒ ÙˆÙ„Ø³Ù‡ Ø§Ù„Ø­ÙƒØ§ÙŠØ© Ø¨ØªØ¨Ø¯Ø£ØŒ ÙˆÙ„Ø³Ù‡ Ù‚Ø¯Ø§Ù…Ù†Ø§ ÙƒØªÙŠØ± Ù‡Ù†Ø¹ÙŠØ´Ù‡ Ø³ÙˆØ§. Ø£Ù†Ø§ Ù…Ø´ Ø¨ÙƒØªØ¨ Ø¹Ø´Ø§Ù† Ø£Ù‚ÙˆÙ„ Ø¥Ù†ÙŠ ÙƒÙ†Øª Ù…Ø®ØªÙ„ÙØŒ ÙˆÙ„Ø§ Ø¹Ù„Ø´Ø§Ù† Ø£ØªÙƒÙ„Ù… Ø¹Ù† Ù†ÙØ³ÙŠâ€¦ Ø£Ù†Ø§ Ø¨ÙƒØªØ¨ Ø¹Ø´Ø§Ù† Ø£Ù‚ÙˆÙ„: "Ø´ÙƒØ±Ù‹Ø§ Ù„ÙŠÙƒÙ…"â€¦ Ø´ÙƒØ±Ù‹Ø§ Ù„ÙƒÙ„ Ø¶Ø­ÙƒØ©ØŒ ÙˆÙƒÙ„ Ù…ÙˆÙ‚ÙØŒ ÙˆÙƒÙ„ Ø¯Ø¹Ù…ØŒ ÙˆÙƒÙ„ Ù„Ø­Ø¸Ø© Ø­Ø³ÙŠØª ÙÙŠÙ‡Ø§ Ø¥Ù†Ù†Ø§ Ù…Ø´ Ù„ÙˆØ­Ø¯Ù†Ø§.
            </p>
             <p>
                Ø£Ù†Ø§ Ù…Ø¨Ø³ÙˆØ· Ø¥Ù†ÙŠ ÙƒÙ†Øª Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø¯ÙØ¹Ø© Ø¯ÙŠØŒ ÙˆÙØ®ÙˆØ± Ø¨ÙƒÙ„ ÙˆØ§Ø­Ø¯ ÙÙŠÙƒÙ….
            </p>
            <hr>
            <p class="call-to-action">
                <strong>ğŸ“© Ø·Ø¨ ÙˆØ¥Ù†ØªØŸ</strong>
            </p>
            <p>
                Ù„Ùˆ ÙˆØµÙ„Øª Ù„Ø¢Ø®Ø± Ø§Ù„ÙƒÙ„Ø§Ù… Ø¯Ù‡â€¦ Ø§ÙƒØªØ¨Ù„ÙŠ ÙƒÙ„Ù…Ø© Ù…Ù† Ø§Ù„Ù„ÙŠ Ø¬ÙˆØ§Ùƒ. Ø§Ø­ÙƒÙŠÙ„ÙŠ Ø¹Ù† Ù„Ø­Ø¸Ø© ÙØ±Ù‘Ù‚Øª Ù…Ø¹Ø§ÙƒØŒ Ø£Ùˆ Ù…ÙˆÙ‚Ù Ù…Ø´ Ù‡ØªÙ†Ø³Ø§Ù‡ØŒ Ø£Ùˆ Ø­Ø¯ Ø¹Ø§ÙŠØ² ØªØ´ÙƒØ±Ù‡. Ø¥Ø­Ù†Ø§ Ø¨Ù†ÙƒÙ…Ù„ Ø¨Ø¨Ø¹Ø¶â€¦ ÙˆØ§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø­Ù„Ùˆ Ø¹Ù…Ø±Ù‡ Ù…Ø§ Ø¨ÙŠØ±ÙˆØ­ â¤
            </p>
            <p class="signature">
                Ø£Ø®ÙˆÙƒÙ…ØŒ<br><strong>Ù…Ø­Ù…Ø¯</strong>
            </p>
        </div>

        <!-- The Wall of Messages -->
        <div class="wall-container" id="wall-container">
            <!-- Cards will be inserted here by JavaScript -->
        </div>
    </div>

    <!-- UI: Floating button to open panel -->
    <button id="open-form-btn" title="Ø£Ø¶Ù Ø±Ø³Ø§Ù„Ø©">+</button>
    
    <!-- UI: Slide-in Panel -->
    <div id="form-panel" class="form-panel">
        <button id="close-form-btn" title="Ø¥ØºÙ„Ø§Ù‚">&times;</button>
        <header>
            <h1>Ø´Ø§Ø±Ùƒ Ø¨ÙƒÙ„Ù…Ø© Ø­Ù„ÙˆØ©</h1>
        </header>
        <main>
            <form id="gratitude-form">
                <input type="text" id="name" placeholder="Ø§Ø³Ù…Ùƒ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                <textarea id="message" rows="10" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø´ÙƒØ± Ø£Ùˆ Ø°ÙƒØ±Ù‰ Ø¬Ù…ÙŠÙ„Ø©..." required></textarea>
                
                <fieldset class="privacy-options">
                    <legend>Ø®ÙŠØ§Ø± Ø§Ù„Ø¹Ø±Ø¶</legend>
                    <div>
                        <input type="radio" id="public" name="privacy" value="public" checked>
                        <label for="public">Ø¹Ø±Ø¶ Ù„Ù„Ø¬Ù…ÙŠØ¹</label>
                    </div>
                    <div>
                        <input type="radio" id="private" name="privacy" value="private">
                        <label for="private">Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ùƒ</label>
                    </div>
                </fieldset>

                <button type="submit">Ø¹Ù„Ù‘Ù‚ Ø±Ø³Ø§Ù„ØªÙƒ</button>
            </form>
        </main>
    </div>

    <!-- Universal Action Modal -->
    <div id="action-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 id="modal-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</h3>
            <div id="modal-body">
                <!-- Content will be injected by JS -->
            </div>
            <div class="modal-buttons">
                <button id="confirm-action-btn">ØªØ£ÙƒÙŠØ¯</button>
                <button id="cancel-action-btn">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <!-- Notification Area -->
    <div id="notification-area"></div>

    <!-- Dependencies -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <script>
        // --- ADMIN CONFIGURATION ---
        const ADMIN_PASSWORD = 'delete2024';

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyC0t2n854hE32yrc7mnxYSpsX3QTkjGtqk",
            authDomain: "gratitude-wall-e4183.firebaseapp.com",
            projectId: "gratitude-wall-e4183",
            storageBucket: "gratitude-wall-e4183.firebasestorage.app",
            messagingSenderId: "472636926451",
            appId: "1:472636926451:web:687dcb8db4f024a3f24a86",
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- UI Elements ---
        const wallContainer = document.getElementById('wall-container');
        const form = document.getElementById('gratitude-form');
        const nameInput = document.getElementById('name');
        const messageInput = document.getElementById('message');
        const notificationArea = document.getElementById('notification-area');
        const modal = document.getElementById('action-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const confirmActionBtn = document.getElementById('confirm-action-btn');
        const cancelActionBtn = document.getElementById('cancel-action-btn');
        const formPanel = document.getElementById('form-panel');
        const openFormBtn = document.getElementById('open-form-btn');
        const closeFormBtn = document.getElementById('close-form-btn');
        
        let actionTargetId = null;
        let currentAction = null; // 'delete' or 'reveal'

        // --- Form Panel Logic ---
        openFormBtn.addEventListener('click', () => formPanel.classList.add('show'));
        closeFormBtn.addEventListener('click', () => formPanel.classList.remove('show'));

        // --- Masonry Layout Logic ---
        function resizeGridItem(item){
            const grid = document.querySelector(".wall-container");
            if (!grid) return; 
            const rowHeight = parseInt(window.getComputedStyle(grid).getPropertyValue('grid-auto-rows'));
            const rowGap = parseInt(window.getComputedStyle(grid).getPropertyValue('gap'));
            const contentWrapper = item.querySelector('.card-content-wrapper');
            if (!contentWrapper) return; 
            const contentHeight = contentWrapper.getBoundingClientRect().height;
            const rowSpan = Math.ceil((contentHeight + rowGap * 2) / (rowHeight + rowGap));
            item.style.gridRowEnd = "span "+rowSpan;
        }

        function resizeAllGridItems(){
            const allItems = document.querySelectorAll(".card");
            allItems.forEach(resizeGridItem);
        }
        window.addEventListener("resize", resizeAllGridItems);
        
        // --- Helper to create Card Element ---
        function createCardElement(docId, noteData) {
            const { message, author, isPublic, isRead } = noteData;

            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = docId;

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'card-content-wrapper';
            
            if (isPublic) {
                contentWrapper.innerHTML = `<p class="card-message">"${message}"</p>`;
            } else { 
                const readIcon = isRead ? 'ğŸ’Œ' : 'â¤ï¸';
                if (isRead) card.classList.add('is-read');

                contentWrapper.innerHTML = `
                    <div class="card-private-content">
                        <div class="lock-icon">${readIcon}</div>
                        <p class="private-text">Ø±Ø³Ø§Ù„Ø© Ø®Ø§ØµØ© Ù„Ùƒ</p>
                    </div>
                `;
                contentWrapper.querySelector('.card-private-content').addEventListener('click', () => openModal('reveal', docId));
            }
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-card-btn';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.title = 'Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                openModal('delete', docId);
            });
            
            card.appendChild(deleteBtn);
            card.appendChild(contentWrapper);
            
            if (author && author.trim() !== '') {
                const authorP = document.createElement('p');
                authorP.className = 'card-author';
                authorP.textContent = `- ${author}`;
                card.appendChild(authorP);
            }

            return card;
        }
        
        // --- Firebase Logic to build the wall ---
        db.collection('notes').orderBy('timestamp', 'desc').onSnapshot(snapshot => {
            snapshot.docChanges().forEach(change => {
                const doc = change.doc;
                const noteData = doc.data();

                if (change.type === "added") {
                    const cardElement = createCardElement(doc.id, noteData);
                    wallContainer.prepend(cardElement);
                    resizeGridItem(cardElement);
                }
                if (change.type === "modified") {
                     const cardToUpdate = document.querySelector(`.card[data-id="${doc.id}"]`);
                     if (cardToUpdate) {
                         const newCard = createCardElement(doc.id, noteData);
                         cardToUpdate.replaceWith(newCard);
                         resizeGridItem(newCard);
                     }
                }
                if (change.type === "removed") {
                    const cardToRemove = document.querySelector(`.card[data-id="${doc.id}"]`);
                    if(cardToRemove) {
                        cardToRemove.style.transition = 'opacity 0.5s, transform 0.5s';
                        cardToRemove.style.opacity = '0';
                        cardToRemove.style.transform = 'scale(0.8)';
                        setTimeout(() => {
                            cardToRemove.remove();
                            resizeAllGridItems();
                        }, 500);
                    }
                }
            });
        });

        // --- Form Submission ---
        form.addEventListener('submit', (e) => {
            e.preventDefault();
             const name = nameInput.value.trim();
             const message = messageInput.value.trim();
             const privacy = document.querySelector('input[name="privacy"]:checked').value;

             if (!message) { showNotification('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ø£ÙˆÙ„Ø§Ù‹.', true); return; }
             db.collection('notes').add({
                author: name,
                message: message,
                isPublic: privacy === 'public',
                isRead: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            }).then(() => {
                showNotification('ØªÙ… ØªØ¹Ù„ÙŠÙ‚ Ø±Ø³Ø§Ù„ØªÙƒ Ø¨Ù†Ø¬Ø§Ø­!');
                nameInput.value = ''; messageInput.value = '';
                formPanel.classList.remove('show');
            }).catch(err => showNotification('Ø­Ø¯Ø« Ø®Ø·Ø£.', true));
        });

        // --- Universal Modal Logic ---
        function openModal(action, docId) {
            currentAction = action;
            actionTargetId = docId;

            // Always show password prompt first for delete/reveal
            modalTitle.textContent = action === 'delete' ? 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù' : 'ÙƒØ´Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø§ØµØ©';
            modalBody.innerHTML = `
                <p id="modal-text">Ù„Ø¥ØªÙ…Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.</p>
                <input type="password" id="password-input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            `;
            confirmActionBtn.textContent = 'ØªØ£ÙƒÙŠØ¯';
            confirmActionBtn.style.display = 'inline-block';
            cancelActionBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
            
            modal.classList.add('show');
            document.getElementById('password-input').focus();
        }

        cancelActionBtn.addEventListener('click', () => modal.classList.remove('show'));
        
        async function handleConfirm() {
            const passwordInput = document.getElementById('password-input');
            if (passwordInput && passwordInput.value !== ADMIN_PASSWORD) {
                showNotification('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.', true);
                passwordInput.value = '';
                return;
            }

            const noteRef = db.collection('notes').doc(actionTargetId);

            if (currentAction === 'delete') {
                await noteRef.delete();
                showNotification('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø±Ø³Ø§Ù„Ø©.');
                modal.classList.remove('show');
            } else if (currentAction === 'reveal') {
                const doc = await noteRef.get();
                if (doc.exists) {
                    const noteData = doc.data();
                    modalTitle.textContent = `Ø±Ø³Ø§Ù„Ø© Ù…Ù† ${noteData.author || 'Ù…Ø¬Ù‡ÙˆÙ„'}`;
                    modalBody.innerHTML = `<div class="revealed-message-body">"${noteData.message}"</div>`;
                    
                    // Change buttons
                    confirmActionBtn.style.display = 'none';
                    cancelActionBtn.textContent = 'Ø¥ØºÙ„Ø§Ù‚';

                    if (!noteData.isRead) {
                        await noteRef.update({ isRead: true });
                    }
                }
            }
        }
        
        confirmActionBtn.addEventListener('click', handleConfirm);
        
        // --- Notification Function ---
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            if (isError) { notification.style.backgroundColor = '#ef4444'; }
            notificationArea.appendChild(notification);
            setTimeout(() => { notification.classList.add('show'); }, 10);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => { notification.remove(); }, 500);
            }, 3000);
        }

    </script>

</body>
</html>
